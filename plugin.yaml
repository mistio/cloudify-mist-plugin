# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                             #
# The tosca_definitions_version is a top-level property of the blueprint that #
# is used to specify the DSL version used.                                    #
#                                                                             #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

tosca_definitions_version: cloudify_dsl_1_2

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                             #
# Plugin declarations allow the installation and use of Python modules        #
# to perform different operations.                                            #
#                                                                             #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

plugins:
  mist:
    executor: central_deployment_agent
    source: "https://github.com/mistio/cloudify-mist-plugin/archive/master.zip"

# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#                                                                             #
# data_types are groups of re-usable common set of properties together with   #
# their types and default values.                                             #
#                                                                             #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

data_types:
  cloudify.datatypes.mist.Config:
    properties:
      mist_username:
          description: >
            The e-mail of the Mist.io user requesting to run this blueprint. Unless
            a user runs this blueprint outside Mist.io (directly using a shell, for
            instance), this input parameter does not need to be provided.
          type: string
          default: ''
      mist_password:
          description: >
            The password associated with the e-mail address specified above. Provide
            a password, in case an e-mail has also been provided in order to generate
            a mist_token used to authenticate to the Mist.io API.
          type: string
          default: ''
      mist_token:
          description: >
            An API Token generated by Mist.io in order to be used with every request
            to authenticate to the Mist.io API. Either a username/password combo or
            a Mist.io Token has to be specified. In the former case, the username &
            password will be used in order to auto-generate an API Token to be used
            in subsequent API calls.
          type: string
          default: ''
      mist_uri:
          description: >
            The Mist.io URI. Points to the Mist.io service that will handle the
            workflows' execution. You should NOT this input, unless you are running
            your own Mist.io installation. Defaults to the Mist.io SaaS.
          type: string
          default: https://mist.io

  cloudify.datatypes.mist.MachineParams:
    properties:
      cloud_id:
          description: >
            The cloud id on which the machine will be created. This is the mist.io 
            specific cloud id that is generated when adding a cloud on the platform.
          type: string
          default: ''
      name:
          description: >
            The name to assign to a new VM. If not specified, one will be generated.
          type: string
          default: ''
      key:
          description: >
            The ID or name of the SSH Key (that may already exists in Mist.io) to be
            deployed on the newly provisioned VMs. If the key does not already exist,
            it will be created.
          type: string
          default: ''
      image_id:
          description: >
            The id of an image to be used on the newly created machine. This is the id
            that is provided by the specific cloud platform.
          type: string
          default: ''
      size_id:
          description: >
            The id of the VM size of the machine to be provisioned. Same as with the 
            machine image this is provider specific, e.g. 't2.micro' or 'm2.xxlarge' 
            for the AWS provider.
          type: string
          default: ''
      location_id:
          description: >
            The location/region to create resources in. If the IaaS supports regions,
            the region will have to be specified by its code and letter identifiers,
            such as "us-east-1" for US East (N. Virginia) in case of Amazon Services.
          type: string
          default: ''
      image_extra:
          description: >
            Image specific extra details. This is used only when provisioning machines
            in Linode.
          type: string
          default: ''
      disk:
          description: >
            The disk that this machine will have. This is only required when provisioning
            Linode machines.
          type: string
          default: ''
      script:
          description: >
            An inline script to run against the machine. For using scripts added to mist
            use the script_id, script_params parameters
          type: string
          default: ''
      monitoring:
          description: >
            This field indicates whether on not to enable monitoring on this machine.
          type: boolean
          default: false
      ips:
          description: >
            A list of IPs to assign to this machine
          default: []
      networks:
          description: >
            A list of networks that this machine belongs to
          default: []
      docker_command:
          desciption: >
            Run a docker command 
          type: string
          default: ''
      script_id:
          description: >
            The id of a script that has been added to mist, to run against this machine.
          type: string
          default: ''
      script_params:
          description: >
            Provides a list of parameters that will be provided to the script indicated
            by the script_id above.
          type: string
          default: ''
      # This is only used in OpenStack clouds
      associate_floating_ip:
          type: boolean
          default: true
      tags:
          description: >
            A set of tags to assign to this machine. The tags will should be
            in the {'key':'provided_tag_key', 'value':'provided_tag_value'}
          default: {}


node_types:
  cloudify.mist.nodes.KeyPair:
    derived_from: cloudify.nodes.Root
    properties:
      install_agent:
        description: >
          Indicates whether or not to install a Cloudify Agent on this host.
        type: boolean
        default: false
      use_external_resource:
        description: >
          Indicate whether the resource exists or if Cloudify should create the resource.
        type: boolean
        default: false
      resource_id:
        description: >
          Either the name or ID of the resource in Cloudify. If this is an existing
          resource, you should provide the name or the ID of the resource in Amazon AWS.
        type: string
        default: ''
      private_key_path:
        description: >
          The path where the key should be saved on the machine. If this is a bootstrap
          process, this refers to the local computer. If this will run on the manager,
          this will be saved on the manager.
        type: string
        default: ''
      parameters:
        description: >
          The key value pair parameters required by Mist Client to use
          the mist.client.backend.create_machine command.(backend_id,image_id
          size_id, location_id, name, monitoring, ssh_user, networks)
        default: {}
      mist_config:
        description: >
          A dictionary of values to pass to authenticate with the Mist API.
        type: cloudify.datatypes.mist.Config
    interfaces:
      cloudify.interfaces.lifecycle:
        create: mist.plugin.keypair.create
        delete: mist.plugin.keypair.delete
      cloudify.interfaces.validation:
        creation: mist.plugin.keypair.creation_validation


  cloudify.mist.nodes.Server:
    derived_from: cloudify.nodes.Compute
    properties:
      install_agent:
        description: >
          Indicates whether or not to install a Cloudify Agent on this host.
        type: boolean
        default: false
      use_external_resource:
        description: >
          Indicate whether the resource exists or if Cloudify should create the resource.
        type: boolean
        default: false
      resource_id:
        description: >
          Either the name or ID of the resource in Cloudify. If this is an existing
          resource, you should provide the name or the ID of the resource in Mist.io.
        type: string
        default: ''
      parameters:
        description: >
          The key value pair parameters required by Mist Client to use
          the mist.client.backend.create_machine command.(backend_id,image_id
          size_id, location_id, name, monitoring, ssh_user, networks )
        type: cloudify.datatypes.mist.MachineParams
      mist_config:
        description: >
          A dictionary of values to pass to authenticate with the Mist API.
        type: cloudify.datatypes.mist.Config
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: mist.plugin.server.create
          inputs:
            use_external_resource:
              description: >
                Indicate whether the resource exists or if Cloudify should create the resource.
              type: boolean
              default: false
            mist_config:
              description: >
                A dictionary of values to pass to authenticate with the Mist API.
              default: {}
        start:
          implementation: mist.plugin.server.start
          inputs:
            start_retry_interval:
              description: Polling interval until the server is active in seconds
              type: integer
              default: 30
        stop:
          implementation: mist.plugin.server.stop
          inputs:
            mist_config:
              description: >
                A dictionary of values to pass to authenticate with the Mist API.
              default: {}
        delete:
          implementation: mist.plugin.server.delete
          inputs:
            mist_config:
              description: >
                A dictionary of values to pass to authenticate with the Mist API.
              default: {}
      cloudify.interfaces.validation:
        creation:
          implementation: mist.plugin.server.creation_validation
          inputs:
            args:
              default: {}

  cloudify.mist.nodes.Network:
    derived_from: cloudify.nodes.Network
    properties:
      install_agent:
        default: false
      use_external_resource:
        description: >
          Indicate whether the resource exists or if Cloudify should create the resource.
        type: boolean
        default: false
      resource_id:
        description: >
          Either the name or ID of the resource in Cloudify. If this is an existing
          resource, you should provide the name or the ID of the resource in Mist.io.
        type: string
        default: ''
      parameters:
        description: >
          The key value pair parameters required by Mist Client to use
          the mist.client.cloud.create_network command.(
          {"network":{"name":"testnet","admin_state_up":true},
          "subnet":{"name":"happy_subnet","ip_version":"4","cidr":"",
          "gateway_ip":"","enable_dhcp":true,
          "allocation_pools":[{"start":"","end":""}]}}: )
        default: {}
      mist_config:
        description: >
          A dictionary of values to pass to authenticate with the Mist API.
        default: {}
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: mist.plugin.network.create
        delete:
          implementation: mist.plugin.network.delete

relationships:
  cloudify.mist.relationships.server_connected_to_keypair:
    derived_from: cloudify.relationships.connected_to
  cloudify.mist.relationships.server_connected_to_network:
    derived_from: cloudify.relationships.depends_on
    target_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: mist.plugin.network.associate_network
          inputs:
            ip:
              default: ''
            assign:
              default: true
